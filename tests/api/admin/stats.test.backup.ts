import { describe, it, expect, beforeEach, jest } from '@jest/globals'
import { getServerSession } from 'next-auth'
import { GET } from '@/app/api/admin/stats/route'\nimport User from '@/models/User'\nimport ProviderProfile from '@/models/ProviderProfile'\nimport Category from '@/models/Category'\nimport DatabaseTestUtils from '../../utils/databaseUtils'\nimport { createMockRequest, mockGetServerSession, createMockAdmin } from '../../utils/testHelpers'\n\njest.mock('next-auth', () => ({\n  getServerSession: jest.fn(),\n}))\n\njest.mock('@/lib/mongodb', () => ({\n  __esModule: true,\n  default: jest.fn().mockResolvedValue(undefined),\n}))\n\ndescribe('/api/admin/stats', () => {\n  let adminUser: any\n  let regularUser: any\n\n  beforeEach(async () => {\n    await DatabaseTestUtils.cleanDatabase()\n    jest.clearAllMocks()\n    \n    // Create admin user\n    adminUser = await User.create({\n      email: 'admin@example.com',\n      name: 'Admin User',\n      roles: ['admin'],\n      emailVerified: true,\n    })\n\n    // Create regular user\n    regularUser = await User.create({\n      email: 'user@example.com',\n      name: 'Regular User',\n      roles: ['client'],\n      emailVerified: true,\n    })\n  })\n\n  describe('GET /api/admin/stats', () => {\n    it('should return comprehensive stats for admin user', async () => {\n      // Seed test data\n      const { users, providers, categories } = await DatabaseTestUtils.seedTestData()\n\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.stats).toBeDefined()\n      \n      // User statistics\n      expect(responseData.stats.users.total).toBeGreaterThanOrEqual(users.length + 2) // +2 for admin and regular user\n      expect(responseData.stats.users.clients).toBeGreaterThan(0)\n      expect(responseData.stats.users.providers).toBeGreaterThan(0)\n      expect(responseData.stats.users.admins).toBeGreaterThanOrEqual(1)\n      expect(responseData.stats.users.verified).toBeGreaterThan(0)\n      \n      // Provider statistics\n      expect(responseData.stats.providers.total).toBe(providers.length)\n      expect(responseData.stats.providers.active).toBeGreaterThan(0)\n      \n      // Category statistics\n      expect(responseData.stats.categories.total).toBe(categories.length)\n      expect(responseData.stats.categories.active).toBeGreaterThan(0)\n      \n      // System information\n      expect(responseData.stats.system.uptime).toBeDefined()\n      expect(responseData.stats.system.version).toBeDefined()\n      expect(responseData.stats.system.database).toBe('Connected')\n    })\n\n    it('should return 401 for unauthenticated user', async () => {\n      mockGetServerSession(null)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(401)\n      expect(responseData.error).toBe('Authentication required')\n    })\n\n    it('should return 403 for non-admin user', async () => {\n      const mockSession = {\n        user: {\n          id: regularUser._id.toString(),\n          email: regularUser.email,\n          roles: ['client'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(403)\n      expect(responseData.error).toBe('Admin access required')\n    })\n\n    it('should return 403 for provider user without admin role', async () => {\n      const providerUser = await User.create({\n        email: 'provider@example.com',\n        name: 'Provider User',\n        roles: ['provider'],\n        emailVerified: true,\n      })\n\n      const mockSession = {\n        user: {\n          id: providerUser._id.toString(),\n          email: providerUser.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(403)\n      expect(responseData.error).toBe('Admin access required')\n    })\n\n    it('should handle empty database correctly', async () => {\n      // Clean all data except admin user\n      await ProviderProfile.deleteMany({})\n      await Category.deleteMany({})\n      await User.deleteMany({ _id: { $ne: adminUser._id } })\n\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.stats.users.total).toBe(1) // Only admin user\n      expect(responseData.stats.users.admins).toBe(1)\n      expect(responseData.stats.providers.total).toBe(0)\n      expect(responseData.stats.categories.total).toBe(0)\n    })\n\n    it('should calculate user role statistics correctly', async () => {\n      // Create users with different role combinations\n      await User.create([\n        { email: 'client1@example.com', name: 'Client 1', roles: ['client'], emailVerified: true },\n        { email: 'client2@example.com', name: 'Client 2', roles: ['client'], emailVerified: false },\n        { email: 'provider1@example.com', name: 'Provider 1', roles: ['provider'], emailVerified: true },\n        { email: 'multi1@example.com', name: 'Multi 1', roles: ['client', 'provider'], emailVerified: true },\n        { email: 'admin2@example.com', name: 'Admin 2', roles: ['admin'], emailVerified: true },\n      ])\n\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      \n      // Total users: 2 existing + 5 new = 7\n      expect(responseData.stats.users.total).toBe(7)\n      \n      // Clients: 1 existing + 3 new (client1, client2, multi1) = 4\n      expect(responseData.stats.users.clients).toBe(4)\n      \n      // Providers: 2 new (provider1, multi1) = 2\n      expect(responseData.stats.users.providers).toBe(2)\n      \n      // Admins: 2 existing + 1 new (admin2) = 3\n      expect(responseData.stats.users.admins).toBe(3)\n      \n      // Verified: all except client2 = 6\n      expect(responseData.stats.users.verified).toBe(6)\n    })\n\n    it('should calculate provider statistics correctly', async () => {\n      // Create providers with different statuses\n      const providerUsers = await User.create([\n        { email: 'activeprov1@example.com', name: 'Active Provider 1', roles: ['provider'] },\n        { email: 'activeprov2@example.com', name: 'Active Provider 2', roles: ['provider'] },\n        { email: 'inactiveprov@example.com', name: 'Inactive Provider', roles: ['provider'] },\n      ])\n\n      await ProviderProfile.create([\n        { userId: providerUsers[0]._id, businessName: 'Active Business 1', isActive: true },\n        { userId: providerUsers[1]._id, businessName: 'Active Business 2', isActive: true },\n        { userId: providerUsers[2]._id, businessName: 'Inactive Business', isActive: false },\n      ])\n\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.stats.providers.total).toBe(3)\n      expect(responseData.stats.providers.active).toBe(2)\n      expect(responseData.stats.providers.inactive).toBe(1)\n    })\n\n    it('should calculate category statistics correctly', async () => {\n      // Create categories with different statuses\n      await Category.create([\n        { name: 'Active Category 1', isActive: true },\n        { name: 'Active Category 2', isActive: true },\n        { name: 'Inactive Category 1', isActive: false },\n        { name: 'Inactive Category 2', isActive: false },\n      ])\n\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.stats.categories.total).toBe(4)\n      expect(responseData.stats.categories.active).toBe(2)\n      expect(responseData.stats.categories.inactive).toBe(2)\n    })\n\n    it('should include system uptime information', async () => {\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.stats.system.uptime).toBeDefined()\n      expect(typeof responseData.stats.system.uptime).toBe('string')\n      \n      // Uptime should be a reasonable string\n      expect(responseData.stats.system.uptime.length).toBeGreaterThan(0)\n    })\n\n    it('should include database connection status', async () => {\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.stats.system.database).toBe('Connected')\n    })\n\n    it('should include application version', async () => {\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.stats.system.version).toBeDefined()\n      expect(typeof responseData.stats.system.version).toBe('string')\n    })\n\n    it('should handle multi-role users correctly in statistics', async () => {\n      // Create users with multiple roles\n      await User.create([\n        { email: 'multi1@example.com', name: 'Multi 1', roles: ['client', 'provider'] },\n        { email: 'multi2@example.com', name: 'Multi 2', roles: ['provider', 'admin'] },\n        { email: 'multi3@example.com', name: 'Multi 3', roles: ['client', 'provider', 'admin'] },\n      ])\n\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      \n      // Each user should be counted in each role they have\n      const stats = responseData.stats.users\n      \n      // Clients: 1 existing + 2 new (multi1, multi3) = 3\n      expect(stats.clients).toBe(3)\n      \n      // Providers: 3 new (multi1, multi2, multi3) = 3\n      expect(stats.providers).toBe(3)\n      \n      // Admins: 1 existing + 2 new (multi2, multi3) = 3\n      expect(stats.admins).toBe(3)\n    })\n\n    it('should handle database errors gracefully', async () => {\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      // Mock User.countDocuments to throw an error\n      const originalCountDocuments = User.countDocuments\n      User.countDocuments = jest.fn().mockRejectedValue(new Error('Database error'))\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(500)\n      expect(responseData.error).toBe('Internal server error')\n\n      // Restore original method\n      User.countDocuments = originalCountDocuments\n    })\n\n    it('should log admin access for audit purposes', async () => {\n      // Mock console.log to capture log output\n      const consoleSpy = jest.spyOn(console, 'log').mockImplementation()\n\n      const mockSession = {\n        user: {\n          id: adminUser._id.toString(),\n          email: adminUser.email,\n          roles: ['admin'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      await GET(request)\n\n      // Verify that admin access was logged\n      expect(consoleSpy).toHaveBeenCalledWith(\n        expect.stringContaining('ðŸ“Š Admin fetching dashboard stats')\n      )\n\n      consoleSpy.mockRestore()\n    })\n  })\n})"