import { describe, it, expect, beforeEach, jest } from '@jest/globals'
import { getServerSession } from 'next-auth'
import { GET, POST, PUT } from '@/app/api/provider/profile/route'
import User from '@/models/User'
import ProviderProfile from '@/models/ProviderProfile'
import DatabaseTestUtils from '../../utils/databaseUtils'
import { createMockRequest, mockGetServerSession, createMockUser, createMockProvider } from '../../utils/testHelpers'

jest.mock('next-auth', () => ({\n  getServerSession: jest.fn(),\n}))\n\njest.mock('@/lib/mongodb', () => ({\n  __esModule: true,\n  default: jest.fn().mockResolvedValue(undefined),\n}))\n\ndescribe('/api/provider/profile', () => {\n  let testUser: any\n  let testProvider: any\n  let testProviderProfile: any\n\n  beforeEach(async () => {\n    await DatabaseTestUtils.cleanDatabase()\n    jest.clearAllMocks()\n    \n    // Create test users\n    testUser = await User.create({\n      email: 'client@example.com',\n      name: 'Test Client',\n      roles: ['client'],\n      emailVerified: true,\n    })\n\n    testProvider = await User.create({\n      email: 'provider@example.com',\n      name: 'Test Provider', \n      roles: ['provider'],\n      emailVerified: true,\n    })\n\n    testProviderProfile = await ProviderProfile.create({\n      userId: testProvider._id,\n      businessName: 'Test Business',\n      description: 'Test business description',\n      contactInfo: {\n        phone: '+381601234567',\n        email: 'business@example.com',\n        address: 'Test Address, Belgrade',\n      },\n      timezone: 'Europe/Belgrade',\n      isActive: true,\n    })\n  })\n\n  describe('GET /api/provider/profile', () => {\n    it('should return provider profile for authenticated provider', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'GET',\n      })\n\n      const response = await GET()\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.profile.businessName).toBe('Test Business')\n      expect(responseData.profile.description).toBe('Test business description')\n      expect(responseData.profile.contactInfo.phone).toBe('+381601234567')\n      expect(responseData.profile.timezone).toBe('Europe/Belgrade')\n      expect(responseData.profile.isActive).toBe(true)\n    })\n\n    it('should return 401 for unauthenticated user', async () => {\n      mockGetServerSession(null)\n\n      const response = await GET()\n      const responseData = await response.json()\n\n      expect(response.status).toBe(401)\n      expect(responseData.error).toBe('Unauthorized')\n    })\n\n    it('should return 403 for non-provider user', async () => {\n      const mockSession = {\n        user: {\n          id: testUser._id.toString(),\n          email: testUser.email,\n          roles: ['client'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const response = await GET()\n      const responseData = await response.json()\n\n      expect(response.status).toBe(403)\n      expect(responseData.error).toBe('User is not a provider')\n    })\n\n    it('should return 404 for provider without profile', async () => {\n      // Create provider without profile\n      const newProvider = await User.create({\n        email: 'newprovider@example.com',\n        name: 'New Provider',\n        roles: ['provider'],\n        emailVerified: true,\n      })\n\n      const mockSession = {\n        user: {\n          id: newProvider._id.toString(),\n          email: newProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const response = await GET()\n      const responseData = await response.json()\n\n      expect(response.status).toBe(404)\n      expect(responseData.error).toBe('Provider profile not found')\n    })\n\n    it('should return 404 for non-existent user', async () => {\n      const mockSession = {\n        user: {\n          id: 'nonexistent@example.com',\n          email: 'nonexistent@example.com',\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const response = await GET()\n      const responseData = await response.json()\n\n      expect(response.status).toBe(404)\n      expect(responseData.error).toBe('User not found')\n    })\n  })\n\n  describe('PUT /api/provider/profile', () => {\n    it('should update existing provider profile', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const updateData = {\n        businessName: 'Updated Business Name',\n        description: 'Updated description',\n        contactInfo: {\n          phone: '+381607654321',\n          email: 'updated@example.com',\n          address: 'Updated Address, Belgrade',\n        },\n        timezone: 'America/New_York',\n        isActive: false,\n      }\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: updateData,\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.message).toBe('Profile updated successfully')\n      expect(responseData.profile.businessName).toBe('Updated Business Name')\n      expect(responseData.profile.description).toBe('Updated description')\n      expect(responseData.profile.contactInfo.phone).toBe('+381607654321')\n      expect(responseData.profile.timezone).toBe('America/New_York')\n      expect(responseData.profile.isActive).toBe(false)\n\n      // Verify database was updated\n      const updatedProfile = await ProviderProfile.findOne({ userId: testProvider._id })\n      expect(updatedProfile?.businessName).toBe('Updated Business Name')\n    })\n\n    it('should create new provider profile if none exists', async () => {\n      // Create provider without profile\n      const newProvider = await User.create({\n        email: 'newprovider@example.com',\n        name: 'New Provider',\n        roles: ['provider'],\n        emailVerified: true,\n      })\n\n      const mockSession = {\n        user: {\n          id: newProvider._id.toString(),\n          email: newProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const profileData = {\n        businessName: 'New Business',\n        description: 'New business description',\n        timezone: 'Europe/Belgrade',\n        isActive: true,\n      }\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: profileData,\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(201)\n      expect(responseData.message).toBe('Profile created successfully')\n      expect(responseData.profile.businessName).toBe('New Business')\n      expect(responseData.profile.userId.toString()).toBe(newProvider._id.toString())\n\n      // Verify profile was created in database\n      const createdProfile = await ProviderProfile.findOne({ userId: newProvider._id })\n      expect(createdProfile).toBeDefined()\n      expect(createdProfile?.businessName).toBe('New Business')\n    })\n\n    it('should return 401 for unauthenticated user', async () => {\n      mockGetServerSession(null)\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: { businessName: 'Test' },\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(401)\n      expect(responseData.error).toBe('Unauthorized')\n    })\n\n    it('should return 403 for non-provider user', async () => {\n      const mockSession = {\n        user: {\n          id: testUser._id.toString(),\n          email: testUser.email,\n          roles: ['client'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: { businessName: 'Test' },\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(403)\n      expect(responseData.error).toBe('User is not a provider')\n    })\n\n    it('should validate required fields', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const invalidData = {\n        businessName: '', // Empty business name\n        timezone: 'Europe/Belgrade',\n      }\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: invalidData,\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(400)\n      expect(responseData.error).toContain('Business name is required')\n    })\n\n    it('should validate email format in contactInfo', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const invalidData = {\n        businessName: 'Valid Business',\n        contactInfo: {\n          email: 'invalid-email-format',\n        },\n        timezone: 'Europe/Belgrade',\n      }\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: invalidData,\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(400)\n      expect(responseData.error).toBeDefined()\n    })\n\n    it('should handle partial updates correctly', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const partialUpdateData = {\n        businessName: 'Partially Updated Business',\n        // Not updating other fields\n      }\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: partialUpdateData,\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.profile.businessName).toBe('Partially Updated Business')\n      // Other fields should remain unchanged\n      expect(responseData.profile.description).toBe('Test business description')\n      expect(responseData.profile.timezone).toBe('Europe/Belgrade')\n    })\n\n    it('should trim whitespace from string fields', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const dataWithSpaces = {\n        businessName: '  Trimmed Business  ',\n        description: '  Trimmed description  ',\n        contactInfo: {\n          phone: '  +381601111111  ',\n          email: '  trimmed@example.com  ',\n        },\n      }\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: dataWithSpaces,\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.profile.businessName).toBe('Trimmed Business')\n      expect(responseData.profile.description).toBe('Trimmed description')\n      expect(responseData.profile.contactInfo.phone).toBe('+381601111111')\n      expect(responseData.profile.contactInfo.email).toBe('trimmed@example.com')\n    })\n  })\n\n  describe('Availability Settings', () => {\n    it('should update availability settings', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const availabilityData = {\n        businessName: 'Business with Availability',\n        availabilitySettings: {\n          monday: { enabled: true, start: '08:00', end: '18:00' },\n          tuesday: { enabled: true, start: '09:00', end: '17:00' },\n          wednesday: { enabled: false, start: '09:00', end: '17:00' },\n          thursday: { enabled: true, start: '09:00', end: '17:00' },\n          friday: { enabled: true, start: '09:00', end: '16:00' },\n          saturday: { enabled: false, start: '09:00', end: '17:00' },\n          sunday: { enabled: false, start: '09:00', end: '17:00' },\n        },\n      }\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: availabilityData,\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.profile.availabilitySettings).toEqual(availabilityData.availabilitySettings)\n\n      // Verify in database\n      const updatedProfile = await ProviderProfile.findOne({ userId: testProvider._id })\n      expect(updatedProfile?.availabilitySettings).toEqual(availabilityData.availabilitySettings)\n    })\n\n    it('should handle complex availability with breaks', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const complexAvailability = {\n        businessName: 'Complex Schedule Business',\n        availabilitySettings: {\n          monday: {\n            enabled: true,\n            start: '08:00',\n            end: '18:00',\n            breaks: [\n              { start: '12:00', end: '13:00', label: 'Lunch Break' },\n              { start: '15:00', end: '15:15', label: 'Coffee Break' },\n            ],\n          },\n          tuesday: {\n            enabled: true,\n            start: '09:00',\n            end: '17:00',\n            customSlots: [\n              { start: '09:00', end: '10:30' },\n              { start: '11:00', end: '12:30' },\n              { start: '14:00', end: '17:00' },\n            ],\n          },\n        },\n      }\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: complexAvailability,\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(200)\n      expect(responseData.profile.availabilitySettings.monday.breaks).toHaveLength(2)\n      expect(responseData.profile.availabilitySettings.tuesday.customSlots).toHaveLength(3)\n    })\n  })\n\n  describe('Error Handling', () => {\n    it('should handle database errors gracefully', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      // Mock ProviderProfile.findOneAndUpdate to throw an error\n      const originalFindOneAndUpdate = ProviderProfile.findOneAndUpdate\n      ProviderProfile.findOneAndUpdate = jest.fn().mockRejectedValue(new Error('Database error'))\n\n      const request = createMockRequest({\n        method: 'PUT',\n        body: { businessName: 'Test Business' },\n      })\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(500)\n      expect(responseData.error).toBe('Internal server error')\n\n      // Restore original method\n      ProviderProfile.findOneAndUpdate = originalFindOneAndUpdate\n    })\n\n    it('should handle invalid JSON in request body', async () => {\n      const mockSession = {\n        user: {\n          id: testProvider._id.toString(),\n          email: testProvider.email,\n          roles: ['provider'],\n        },\n      }\n      \n      mockGetServerSession(mockSession)\n\n      const request = {\n        json: jest.fn().mockRejectedValue(new Error('Invalid JSON')),\n      } as unknown as Request\n\n      const response = await PUT(request)\n      const responseData = await response.json()\n\n      expect(response.status).toBe(400)\n      expect(responseData.error).toBe('Invalid request body')\n    })\n  })\n})"